---
import { ViewTransitions } from 'astro:transitions';
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import { EXTERNAL_URLS, TYPOGRAPHY } from '../config/app.config';
import { APP_CONFIG } from '../constants/index';
import LanguageSelector from '../components/language/LanguageSelector.astro';
import Logo from '../components/Logo';
import SearchBar from '../components/search/SearchBar.astro';
import Sidebar from '../components/sidebar/Sidebar.astro';
import ThemeToggleAstro from '../components/theme/ThemeToggleAstro.astro';
import '../styles/global.css';

export interface Props {
  title: string;
  description?: string;
  showSidebar?: boolean;
  lang?: string;
  compactFooter?: boolean;
  image?: string;
  type?: 'website' | 'article';
}

const {
  title,
  description,
  showSidebar = false,
  lang: propLang,
  compactFooter = false,
  image,
  type = 'website'
} = Astro.props;

const lang = propLang || getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const finalDescription = description || t('site.description');
const baseUrl = (import.meta.env.BASE_URL || '/').endsWith('/')
  ? import.meta.env.BASE_URL
  : import.meta.env.BASE_URL + '/';

// SEO URLs
const siteUrl = 'https://cncerthub.xyz';
const currentPath = Astro.url.pathname.replace(/^\/+/, '');
const canonicalURL = new URL(`/${currentPath}`, siteUrl).href.replace(/\/$/, '') || siteUrl;

// Default OG Image (1200x630 for optimal social sharing)
const ogImage = image || `${siteUrl}/og-image.png`;

// Hreflang URLs
const pathWithoutLang = currentPath.replace(/^(es|pt)\//, '');
const hreflangUrls = {
  en: `${siteUrl}/${pathWithoutLang}`.replace(/\/$/, '') || siteUrl,
  es: `${siteUrl}/es/${pathWithoutLang}`.replace(/\/$/, ''),
  pt: `${siteUrl}/pt/${pathWithoutLang}`.replace(/\/$/, ''),
};
---

<!doctype html>
<html lang={lang} transition:animate="none">
  <head>
    <meta charset="UTF-8" />
    <!-- Theme initialization - runs on every page load/navigation -->
    <script is:inline data-astro-rerun>
      (function() {
        var PREFS_VERSION = '2';
        var theme;
        try {
          // Check if we need to reset preferences to new defaults
          var storedVersion = localStorage.getItem('prefsVersion');
          if (storedVersion !== PREFS_VERSION) {
            // Reset to new defaults: dark theme, collapsed sidebar
            localStorage.setItem('prefsVersion', PREFS_VERSION);
            localStorage.setItem('theme', 'dark');
            localStorage.removeItem('sidebarOpenSections');
            localStorage.removeItem('sidebarOpenCategories');
            theme = 'dark';
          } else {
            theme = localStorage.getItem('theme');
            // Default to dark if no preference saved (only light if explicitly set)
            if (theme !== 'light') {
              theme = 'dark';
            }
          }
        } catch(e) {
          theme = 'dark';
        }
        document.documentElement.classList.remove('dark', 'light');
        document.documentElement.classList.add(theme);
        // Disable backdrop-filter in Firefox to avoid APZ scroll-linked warnings
        if (navigator.userAgent.indexOf('Firefox') > -1) {
          document.documentElement.classList.add('no-backdrop-filter');
        }
      })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <!-- Security Headers (meta-based for GitHub Pages compatibility) -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=()" />

    <!-- Content Security Policy - Note: frame-ancestors only works via HTTP headers (see public/_headers) -->
    <!-- CSP handled via HTTP headers in public/_headers for better security -->

    <!-- Primary Meta Tags -->
    <title>{title} | Cloud Native Certification Resources Hub</title>
    <meta name="title" content={`${title} | Cloud Native Certification Resources Hub`} />
    <meta name="description" content={finalDescription} />
    <meta name="keywords" content="CNCF, Kubernetes, CKA, CKAD, CKS, KCNA, KCSA, certification, cloud native, DevOps, container, exam preparation" />
    <meta name="author" content="CNCertHub" />
    <meta name="robots" content="index, follow" />
    <meta name="theme-color" content="#1E50D9" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#0F172A" media="(prefers-color-scheme: dark)" />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />

    <!-- Hreflang for International SEO -->
    <link rel="alternate" hreflang="en" href={hreflangUrls.en} />
    <link rel="alternate" hreflang="es" href={hreflangUrls.es} />
    <link rel="alternate" hreflang="pt" href={hreflangUrls.pt} />
    <link rel="alternate" hreflang="x-default" href={hreflangUrls.en} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={`${title} | Cloud Native Certification Resources Hub`} />
    <meta property="og:description" content={finalDescription} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:alt" content="Cloud Native Certification Resources Hub - Study Guides for CKA, CKAD, CKS, KCNA, KCSA and more" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:locale" content={lang === 'es' ? 'es_ES' : lang === 'pt' ? 'pt_BR' : 'en_US'} />
    <meta property="og:site_name" content="Cloud Native Certification Resources Hub" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={`${title} | Cloud Native Certification Resources Hub`} />
    <meta name="twitter:description" content={finalDescription} />
    <meta name="twitter:image" content={ogImage} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href={`${baseUrl}favicon.svg`} />
    <link rel="apple-touch-icon" sizes="180x180" href={`${baseUrl}apple-touch-icon.png`} />

    <!-- View Transitions with instant swap -->
    <ViewTransitions />

    <!-- Performance: DNS Prefetch for external resources -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.gstatic.com" />

    <!-- Optimized font loading: preconnect + preload + display=swap for best performance -->
    <!-- Preconnect establishes early connections to font servers -->
    <link rel="preconnect" href={EXTERNAL_URLS.fonts.googleapis} />
    <link rel="preconnect" href={EXTERNAL_URLS.fonts.gstatic} crossorigin />

    <!-- Preload critical font CSS for faster LCP -->
    <link rel="preload" href={EXTERNAL_URLS.fonts.googleFontsCss} as="style" />

    <!-- Load Google Fonts CSS with display=swap for faster rendering -->
    <!-- Using variable fonts reduces HTTP requests and provides smooth weight transitions -->
    <link href={EXTERNAL_URLS.fonts.googleFontsCss} rel="stylesheet" media="print" onload="this.media='all'" />
    <noscript><link href={EXTERNAL_URLS.fonts.googleFontsCss} rel="stylesheet" /></noscript>
    
    <!-- Note: Astro automatically handles preloading of compiled assets -->

    <!-- Critical anti-flash CSS - Minimal inline styles for instant render -->
    <style is:global>
      /* Theme colors - Clean white palette */
      :root {
        color-scheme: light dark;
        --bg-primary: #FFFFFF; /* white - clean background */
        --text-primary: #0F172A;
      }

      .dark {
        --bg-primary: #1E293B; /* neutral-800 - main content area */
        --text-primary: #F1F5F9;
      }

      /* Prevent white flash - set background immediately */
      html, body {
        background-color: var(--bg-primary);
        color: var(--text-primary);
      }

      /* COMPLETELY DISABLE View Transitions animations - highest specificity */
      ::view-transition-group(*),
      ::view-transition-old(*),
      ::view-transition-new(*) {
        animation: none !important;
        animation-duration: 0s !important;
        animation-delay: 0s !important;
      }

      /* Override Astro's generated transition animations */
      ::view-transition-old(astro-smooz4hq-1),
      ::view-transition-new(astro-smooz4hq-1) {
        animation: none !important;
        animation-duration: 0s !important;
      }

      /* Set explicit background during view transition - use dark color by default */
      ::view-transition,
      ::view-transition-group(root),
      ::view-transition-image-pair(root) {
        background-color: #1E293B !important; /* dark mode color */
      }

      /* Override for light mode */
      html:not(.dark) ::view-transition,
      html:not(.dark) ::view-transition-group(root),
      html:not(.dark) ::view-transition-image-pair(root),
      html.light ::view-transition,
      html.light ::view-transition-group(root),
      html.light ::view-transition-image-pair(root) {
        background-color: #FFFFFF !important; /* light mode color - white */
      }

      /* Hide old snapshot immediately, show new one instantly */
      ::view-transition-old(root) {
        display: none !important;
        opacity: 0 !important;
      }
      ::view-transition-new(root) {
        animation: none !important;
        opacity: 1 !important;
      }
    </style>

    <!-- Apply theme before View Transition swap to prevent flash -->
    <script is:inline>
      (function() {
        function getTheme() {
          try {
            var t = localStorage.getItem('theme');
            if (t === 'light') return 'light';
          } catch(e) {}
          // Default to dark
          return 'dark';
        }

        document.addEventListener('astro:before-swap', function(event) {
          var theme = getTheme();
          event.newDocument.documentElement.classList.remove('dark', 'light');
          event.newDocument.documentElement.classList.add(theme);
        });
      })();
    </script>

    <!-- Structured Data - JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Cloud Native Certification Resources Hub",
      "description": finalDescription,
      "url": siteUrl,
      "inLanguage": [lang, "en", "es", "pt"],
      "publisher": {
        "@type": "Organization",
        "name": "CNCertHub",
        "logo": {
          "@type": "ImageObject",
          "url": `${siteUrl}/favicon.svg`
        }
      },
      "potentialAction": {
        "@type": "SearchAction",
        "target": `${siteUrl}/?q={search_term_string}`,
        "query-input": "required name=search_term_string"
      }
    })} />

    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": siteUrl
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": title,
          "item": canonicalURL
        }
      ]
    })} />
  </head>
  <body class="min-h-screen">
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-0 focus:left-0 bg-blue-600 text-white p-2 z-50 rounded-br-md focus:outline-none focus:ring-2 focus:ring-blue-400 font-medium"
      tabindex="0"
    >
      {t('accessibility.skipToMain')}
    </a>
    
    <!-- WowDash-style Header -->
    <header
      transition:persist={`header-${lang}`}
      transition:animate="none"
      class={`header-persistent fixed top-0 z-50 bg-white dark:bg-neutral-900 border-b border-slate-200 dark:border-neutral-800 transition-all duration-300 left-0 right-0 ${showSidebar ? 'lg:left-[280px]' : ''}`}
    >
      <div class="h-16 px-4 flex items-center">
        {/* Left: Mobile Menu Button + Logo (mobile only) */}
        <div class="flex items-center gap-2 flex-shrink-0">
          {showSidebar && (
            <button
              id="mobile-menu-btn"
              class="lg:hidden inline-flex items-center justify-center w-10 h-10 text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200 hover:bg-neutral-100 dark:hover:bg-neutral-800 rounded-lg transition-all duration-200"
              aria-label="Toggle menu"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
              </svg>
            </button>
          )}

          {/* Logo text - visible on mobile only (hidden on lg when sidebar shows logo) */}
          <a href={`${baseUrl}${lang === 'en' ? '' : lang + '/'}`} class="lg:hidden flex items-center">
            <span class="text-2xl font-bold text-neutral-900 dark:text-white">CN</span>
            <span class="text-2xl font-bold text-primary-600">Cert</span>
            <span class="text-2xl font-bold text-neutral-900 dark:text-white">Hub</span>
          </a>
        </div>

        {/* Center: Search Bar - Always centered */}
        <div class="hidden sm:flex flex-1 justify-center mx-2">
          <div class="w-full max-w-md">
            <SearchBar lang={lang} />
          </div>
        </div>

        {/* Right: Actions */}
        <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0 ms-auto">
          {/* Mobile Search - Only visible below sm (640px) */}
          <div class="sm:hidden">
            <SearchBar lang={lang} />
          </div>

          <!-- Theme Toggle - Disabled (dark mode only) -->
          <!-- <ThemeToggleAstro /> -->

          <!-- Language Selector -->
          <LanguageSelector currentLang={lang} />

          <!-- GitHub Link -->
          <a
            href={EXTERNAL_URLS.github}
            target="_blank"
            rel="noopener noreferrer"
            class="hidden sm:inline-flex items-center justify-center w-10 h-10 text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200 hover:bg-neutral-100 dark:hover:bg-neutral-800 rounded-lg transition-all duration-200"
            aria-label="GitHub Repository"
          >
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path>
            </svg>
          </a>
        </div>
      </div>
    </header>

    <!-- Mobile Menu Toggle Script - Pure DOM approach for resilience -->
    <script is:inline data-astro-rerun>
      (function() {
        // Prevent duplicate listeners
        if (window._mobileMenuInitialized) return;
        window._mobileMenuInitialized = true;

        // Toggle mobile sidebar - uses body class for state
        function toggleMobileSidebar() {
          document.body.classList.toggle('mobile-sidebar-open');
        }

        // Close mobile sidebar
        function closeMobileSidebar() {
          document.body.classList.remove('mobile-sidebar-open');
        }

        // Setup click handler using event delegation (more resilient)
        function handleClick(e) {
          // Check if click is on hamburger button or its children
          var btn = e.target.closest('#mobile-menu-btn');
          if (btn) {
            e.preventDefault();
            e.stopPropagation();
            toggleMobileSidebar();
            return;
          }

          // Check if click is on mobile backdrop
          var backdrop = e.target.closest('[data-mobile-backdrop]');
          if (backdrop) {
            closeMobileSidebar();
            return;
          }

          // Check if click is on sidebar close button
          var closeBtn = e.target.closest('[data-sidebar-close]');
          if (closeBtn) {
            closeMobileSidebar();
            return;
          }

          // Check if click is on sidebar link (close after navigation)
          var sidebarLink = e.target.closest('.sidebar-nav-link');
          if (sidebarLink) {
            closeMobileSidebar();
          }
        }

        // Use single document-level listener (survives View Transitions)
        document.addEventListener('click', handleClick, true);

        // Also add direct listener to hamburger button as fallback
        document.addEventListener('DOMContentLoaded', function() {
          var menuBtn = document.getElementById('mobile-menu-btn');
          if (menuBtn) {
            menuBtn.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              toggleMobileSidebar();
            });
          }
        });

        // Close sidebar on navigation
        document.addEventListener('astro:before-swap', closeMobileSidebar);

        // Expose for external use
        window.toggleMobileSidebar = toggleMobileSidebar;
        window.closeMobileSidebar = closeMobileSidebar;
      })();
    </script>
    
    <div class="min-h-screen">
      {showSidebar && (
        <div transition:persist={`sidebar-${lang}`} transition:animate="none" class="sidebar-persistent">
          {/* Static sidebar shell - visible immediately while React loads */}
          <aside
            id="sidebar-placeholder"
            class="fixed top-0 h-screen z-40 w-[280px] bg-white dark:bg-neutral-900 hidden lg:block"
          >
            <div class="h-16 px-5 flex items-center border-b border-neutral-200 dark:border-neutral-800 lg:border-0">
              <span class="text-3xl font-bold text-neutral-900 dark:text-white">CN</span>
              <span class="text-3xl font-bold text-primary-600">Cert</span>
              <span class="text-3xl font-bold text-neutral-900 dark:text-white">Hub</span>
            </div>
          </aside>
          <Sidebar lang={lang} />
        </div>
      )}

      <div
        class={`flex flex-col min-h-screen pt-16 transition-all duration-300 ${showSidebar ? 'lg:ml-[280px]' : ''}`}
        id="main-wrapper"
        data-sidebar={showSidebar}
      >
        <main class="flex-grow" id="main-content" role="main" aria-label={t('accessibility.mainContent')}>
          <slot />
        </main>
        
        <footer transition:persist={`footer-${lang}`} class={`relative bg-white dark:bg-neutral-900 border-t border-slate-200 dark:border-neutral-800 ${compactFooter ? 'mt-0' : 'mt-20'}`} id="footer">
          <div class="w-full px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-6">
              {/* Description */}
              <div class="flex flex-col sm:flex-row items-center gap-4">
                <div class="flex items-center">
                  <span class="text-xl sm:text-2xl font-bold text-neutral-900 dark:text-white">CN</span>
                  <span class="text-xl sm:text-2xl font-bold text-primary-800">Cert</span>
                  <span class="text-xl sm:text-2xl font-bold text-neutral-900 dark:text-white">Hub</span>
                </div>
                <div class="hidden sm:block w-px h-8 bg-neutral-300 dark:bg-neutral-600"></div>
                <p class="text-neutral-900 dark:text-neutral-100 text-base text-center sm:text-left max-w-md">
                  {t('footer.disclaimer')}
                </p>
              </div>

              {/* Links */}
              <a
                href="https://blog.labjp.xyz"
                target="_blank"
                rel="noopener noreferrer"
                class="group inline-flex items-center gap-2 px-2 py-1 rounded-lg hover:bg-emerald-500/10 transition-colors duration-200"
                aria-label="labjp.xyz"
              >
                <span class="text-emerald-500 font-mono text-base font-bold">&gt;_</span>
                <span class="text-emerald-500 font-mono text-base font-bold tracking-wide group-hover:text-emerald-400 transition-colors duration-200">labjp.xyz</span>
                <svg class="w-3.5 h-3.5 text-emerald-500 group-hover:text-emerald-400 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
              </a>
            </div>

          </div>
        </footer>
      </div>
    </div>
    
    <script>
      // Final fallback to ensure content is visible
      setTimeout(() => {
        if (!document.documentElement.classList.contains('visible')) {
          document.documentElement.classList.add('visible');
        }
      }, 1000);
    </script>
  </body>
</html>