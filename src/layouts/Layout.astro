---
import { ViewTransitions } from 'astro:transitions';
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import { EXTERNAL_URLS, TYPOGRAPHY } from '../config/app.config';
import { APP_CONFIG } from '../constants/index';
import LanguageSelector from '../components/language/LanguageSelector';
import Logo from '../components/Logo';
import SearchBar from '../components/search/SearchBar';
import Sidebar from '../components/sidebar/Sidebar';
import ThemeToggle from '../components/theme/ThemeToggle';
import '../styles/global.css';

export interface Props {
  title: string;
  description?: string;
  showSidebar?: boolean;
  lang?: string;
  compactFooter?: boolean;
  image?: string;
  type?: 'website' | 'article';
}

const {
  title,
  description,
  showSidebar = false,
  lang: propLang,
  compactFooter = false,
  image,
  type = 'website'
} = Astro.props;

const lang = propLang || getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const finalDescription = description || t('site.description');
const baseUrl = (import.meta.env.BASE_URL || '/').endsWith('/')
  ? import.meta.env.BASE_URL
  : import.meta.env.BASE_URL + '/';

// SEO URLs
const siteUrl = 'https://cncerthub.xyz';
const currentPath = Astro.url.pathname.replace(/^\/+/, '');
const canonicalURL = new URL(`/${currentPath}`, siteUrl).href.replace(/\/$/, '') || siteUrl;

// Default OG Image (1200x630 for optimal social sharing)
const ogImage = image || `${siteUrl}/og-image.png`;

// Hreflang URLs
const pathWithoutLang = currentPath.replace(/^(es|pt)\//, '');
const hreflangUrls = {
  en: `${siteUrl}/${pathWithoutLang}`.replace(/\/$/, '') || siteUrl,
  es: `${siteUrl}/es/${pathWithoutLang}`.replace(/\/$/, ''),
  pt: `${siteUrl}/pt/${pathWithoutLang}`.replace(/\/$/, ''),
};
---

<!doctype html>
<html lang={lang} transition:animate="none">
  <head>
    <meta charset="UTF-8" />
    <!-- Theme initialization - runs on every page load/navigation -->
    <script is:inline data-astro-rerun>
      (function() {
        var theme;
        try { theme = localStorage.getItem('theme'); } catch(e) {}
        if (theme !== 'dark' && theme !== 'light') {
          theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        document.documentElement.classList.remove('dark', 'light');
        document.documentElement.classList.add(theme);
      })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{title} | Cloud Native Certification Resources Hub</title>
    <meta name="title" content={`${title} | Cloud Native Certification Resources Hub`} />
    <meta name="description" content={finalDescription} />
    <meta name="keywords" content="CNCF, Kubernetes, CKA, CKAD, CKS, KCNA, KCSA, certification, cloud native, DevOps, container, exam preparation" />
    <meta name="author" content="CNCertHub" />
    <meta name="robots" content="index, follow" />
    <meta name="theme-color" content="#1E50D9" />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />

    <!-- Hreflang for International SEO -->
    <link rel="alternate" hreflang="en" href={hreflangUrls.en} />
    <link rel="alternate" hreflang="es" href={hreflangUrls.es} />
    <link rel="alternate" hreflang="pt" href={hreflangUrls.pt} />
    <link rel="alternate" hreflang="x-default" href={hreflangUrls.en} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={`${title} | Cloud Native Certification Resources Hub`} />
    <meta property="og:description" content={finalDescription} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:alt" content="Cloud Native Certification Resources Hub - Study Guides for CKA, CKAD, CKS, KCNA, KCSA and more" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:locale" content={lang === 'es' ? 'es_ES' : lang === 'pt' ? 'pt_BR' : 'en_US'} />
    <meta property="og:site_name" content="Cloud Native Certification Resources Hub" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={`${title} | Cloud Native Certification Resources Hub`} />
    <meta name="twitter:description" content={finalDescription} />
    <meta name="twitter:image" content={ogImage} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href={`${baseUrl}favicon.svg`} />
    <link rel="apple-touch-icon" sizes="180x180" href={`${baseUrl}apple-touch-icon.png`} />

    <!-- View Transitions with instant swap -->
    <ViewTransitions />
    
    <!-- Optimized font loading: preconnect + preload + display=swap for best performance -->
    <!-- Preconnect establishes early connections to font servers -->
    <link rel="preconnect" href={EXTERNAL_URLS.fonts.googleapis} />
    <link rel="preconnect" href={EXTERNAL_URLS.fonts.gstatic} crossorigin />

    <!-- Load Google Fonts CSS with display=swap for faster rendering -->
    <!-- Using variable fonts reduces HTTP requests and provides smooth weight transitions -->
    <link href={EXTERNAL_URLS.fonts.googleFontsCss} rel="stylesheet" />
    
    <!-- Note: Astro automatically handles preloading of compiled assets -->

    <!-- Critical anti-flash CSS - Minimal inline styles for instant render -->
    <style is:global>
      /* Theme colors - Blue-tinted neutral palette */
      :root {
        color-scheme: light dark;
        --bg-primary: #E2E8F0; /* neutral-200 - light gray for body */
        --text-primary: #0F172A;
      }

      .dark {
        --bg-primary: #1E293B; /* neutral-800 - main content area */
        --text-primary: #F1F5F9;
      }

      /* Prevent white flash - set background immediately */
      html, body {
        background-color: var(--bg-primary);
        color: var(--text-primary);
      }

      /* COMPLETELY DISABLE View Transitions animations - highest specificity */
      ::view-transition-group(*),
      ::view-transition-old(*),
      ::view-transition-new(*) {
        animation: none !important;
        animation-duration: 0s !important;
        animation-delay: 0s !important;
      }

      /* Override Astro's generated transition animations */
      ::view-transition-old(astro-smooz4hq-1),
      ::view-transition-new(astro-smooz4hq-1) {
        animation: none !important;
        animation-duration: 0s !important;
      }

      /* Set explicit background during view transition - use dark color by default */
      ::view-transition,
      ::view-transition-group(root),
      ::view-transition-image-pair(root) {
        background-color: #1E293B !important; /* dark mode color */
      }

      /* Override for light mode */
      html:not(.dark) ::view-transition,
      html:not(.dark) ::view-transition-group(root),
      html:not(.dark) ::view-transition-image-pair(root),
      html.light ::view-transition,
      html.light ::view-transition-group(root),
      html.light ::view-transition-image-pair(root) {
        background-color: #E2E8F0 !important; /* light mode color */
      }

      /* Hide old snapshot immediately, show new one instantly */
      ::view-transition-old(root) {
        display: none !important;
        opacity: 0 !important;
      }
      ::view-transition-new(root) {
        animation: none !important;
        opacity: 1 !important;
      }
    </style>

    <!-- Apply theme before View Transition swap to prevent flash -->
    <script is:inline>
      (function() {
        function getTheme() {
          try {
            var t = localStorage.getItem('theme');
            if (t === 'dark' || t === 'light') return t;
          } catch(e) {}
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        document.addEventListener('astro:before-swap', function(event) {
          var theme = getTheme();
          event.newDocument.documentElement.classList.remove('dark', 'light');
          event.newDocument.documentElement.classList.add(theme);
        });
      })();
    </script>

    <!-- Structured Data - JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Cloud Native Certification Resources Hub",
      "description": finalDescription,
      "url": siteUrl,
      "inLanguage": [lang, "en", "es", "pt"],
      "publisher": {
        "@type": "Organization",
        "name": "CNCertHub",
        "logo": {
          "@type": "ImageObject",
          "url": `${siteUrl}/favicon.svg`
        }
      },
      "potentialAction": {
        "@type": "SearchAction",
        "target": `${siteUrl}/?q={search_term_string}`,
        "query-input": "required name=search_term_string"
      }
    })} />

    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": siteUrl
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": title,
          "item": canonicalURL
        }
      ]
    })} />
  </head>
  <body class="min-h-screen">
    <a 
      href="#main-content" 
      class="sr-only focus:not-sr-only focus:absolute focus:top-0 focus:left-0 bg-blue-600 text-white p-2 z-50 rounded-br-md focus:outline-none focus:ring-2 focus:ring-blue-400 font-medium"
      tabindex="1"
    >
      {t('accessibility.skipToMain')}
    </a>
    
    <!-- WowDash-style Header -->
    <header
      transition:persist={`header-${lang}`}
      class={`fixed top-0 z-50 bg-neutral-100 dark:bg-neutral-900 border-b border-neutral-200 dark:border-neutral-800 transition-all duration-300 left-0 right-0 ${showSidebar ? 'lg:left-[280px]' : ''}`}
    >
      <div class="h-16 px-4 flex items-center">
        {/* Left: Mobile Menu Button + Logo (mobile only) */}
        <div class="flex items-center gap-2 flex-shrink-0">
          {showSidebar && (
            <button
              id="mobile-menu-btn"
              class="lg:hidden inline-flex items-center justify-center w-10 h-10 text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200 hover:bg-neutral-100 dark:hover:bg-neutral-800 rounded-lg transition-all duration-200"
              aria-label="Toggle menu"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
              </svg>
            </button>
          )}

          {/* Logo - visible on mobile only (hidden on lg when sidebar shows logo) */}
          <a href={`${baseUrl}${lang === 'en' ? '' : lang + '/'}`} class="lg:hidden flex items-center gap-2">
            <div class="w-8 h-8 sm:w-9 sm:h-9 rounded-lg bg-primary-600 flex items-center justify-center flex-shrink-0">
              <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
              </svg>
            </div>
            <div class="flex">
              <span class="text-2xl sm:text-3xl font-bold text-neutral-900 dark:text-white">CN</span>
              <span class="text-2xl sm:text-3xl font-bold text-primary-600">Cert</span>
              <span class="text-2xl sm:text-3xl font-bold text-neutral-900 dark:text-white">Hub</span>
            </div>
          </a>
        </div>

        {/* Center: Search Bar - Always centered */}
        <div class="hidden sm:flex flex-1 justify-center mx-2">
          <div class="w-full max-w-md">
            <SearchBar client:idle lang={lang} />
          </div>
        </div>

        {/* Right: Actions */}
        <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0 ms-auto">
          {/* Mobile Search - Only visible below sm (640px) */}
          <div class="sm:hidden">
            <SearchBar client:idle lang={lang} />
          </div>

          <!-- Theme Toggle -->
          <ThemeToggle client:only="react" />

          <!-- Language Selector -->
          <LanguageSelector client:idle currentLang={lang} />

          <!-- GitHub Link -->
          <a
            href={EXTERNAL_URLS.github}
            target="_blank"
            rel="noopener noreferrer"
            class="hidden sm:inline-flex items-center justify-center w-10 h-10 text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200 hover:bg-neutral-100 dark:hover:bg-neutral-800 rounded-lg transition-all duration-200"
            aria-label="GitHub Repository"
          >
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path>
            </svg>
          </a>
        </div>
      </div>
    </header>

    <!-- Mobile Menu Toggle Script - Pure DOM approach for resilience -->
    <script is:inline data-astro-rerun>
      (function() {
        // Prevent duplicate listeners
        if (window._mobileMenuInitialized) return;
        window._mobileMenuInitialized = true;

        // Toggle mobile sidebar - uses body class for state
        function toggleMobileSidebar() {
          document.body.classList.toggle('mobile-sidebar-open');
        }

        // Close mobile sidebar
        function closeMobileSidebar() {
          document.body.classList.remove('mobile-sidebar-open');
        }

        // Setup click handler using event delegation (more resilient)
        function handleClick(e) {
          // Check if click is on hamburger button or its children
          var btn = e.target.closest('#mobile-menu-btn');
          if (btn) {
            e.preventDefault();
            e.stopPropagation();
            toggleMobileSidebar();
            return;
          }

          // Check if click is on mobile backdrop
          var backdrop = e.target.closest('[data-mobile-backdrop]');
          if (backdrop) {
            closeMobileSidebar();
            return;
          }

          // Check if click is on sidebar close button
          var closeBtn = e.target.closest('[data-sidebar-close]');
          if (closeBtn) {
            closeMobileSidebar();
            return;
          }

          // Check if click is on sidebar link (close after navigation)
          var sidebarLink = e.target.closest('.sidebar-nav-link');
          if (sidebarLink) {
            closeMobileSidebar();
          }
        }

        // Use single document-level listener (survives View Transitions)
        document.addEventListener('click', handleClick, true);

        // Also add direct listener to hamburger button as fallback
        document.addEventListener('DOMContentLoaded', function() {
          var menuBtn = document.getElementById('mobile-menu-btn');
          if (menuBtn) {
            menuBtn.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              toggleMobileSidebar();
            });
          }
        });

        // Close sidebar on navigation
        document.addEventListener('astro:before-swap', closeMobileSidebar);

        // Expose for external use
        window.toggleMobileSidebar = toggleMobileSidebar;
        window.closeMobileSidebar = closeMobileSidebar;
      })();
    </script>
    
    <div class="min-h-screen">
      {showSidebar && (
        <div transition:persist={`sidebar-${lang}`}>
          <Sidebar client:only="react" lang={lang} />
        </div>
      )}

      <div
        class={`flex flex-col min-h-screen pt-16 transition-all duration-300 ${showSidebar ? 'lg:ml-[280px]' : ''}`}
        id="main-wrapper"
        data-sidebar={showSidebar}
      >
        <main class="flex-grow" id="main-content" role="main" aria-label={t('accessibility.mainContent')}>
          <slot />
        </main>
        
        <footer transition:persist={`footer-${lang}`} class={`relative bg-neutral-100 dark:bg-neutral-900 border-t border-neutral-200 dark:border-neutral-800 ${compactFooter ? 'mt-0' : 'mt-20'}`} id="footer">
          <div class="w-full px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-6">
              {/* Description */}
              <div class="flex flex-col sm:flex-row items-center gap-4">
                <div class="flex items-center">
                  <span class="text-xl sm:text-2xl font-bold text-neutral-900 dark:text-white">CN</span>
                  <span class="text-xl sm:text-2xl font-bold text-primary-600">Cert</span>
                  <span class="text-xl sm:text-2xl font-bold text-neutral-900 dark:text-white">Hub</span>
                </div>
                <div class="hidden sm:block w-px h-8 bg-neutral-300 dark:bg-neutral-600"></div>
                <p class="text-neutral-500 dark:text-neutral-400 text-base text-center sm:text-left max-w-md">
                  {t('footer.disclaimer')}
                </p>
              </div>

              {/* Links */}
              <a
                href="https://blog.labjp.xyz"
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-1 text-lg font-bold font-mono text-emerald-500 hover:text-emerald-400 transition-colors"
                aria-label="labjp.xyz"
              >
                <span>&gt;_</span>
                <span>labjp.xyz</span>
              </a>
            </div>

          </div>
        </footer>
      </div>
    </div>
    
    <script>
      // Final fallback to ensure content is visible
      setTimeout(() => {
        if (!document.documentElement.classList.contains('visible')) {
          document.documentElement.classList.add('visible');
        }
      }, 1000);
    </script>
  </body>
</html>